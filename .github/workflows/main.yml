name: Android Kernel Driver Builder

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture (aarch64, x86_64, etc.)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        
      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/
          
      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile

      - name: Add module to GKI modules list
        if: ${{ github.event.inputs.android_version > 13 }}
        run: |
          cd android-kernel
          MODULE_NAME="drivers/kerneldriver/${{ github.event.inputs.driver_name }}"
          
          awk -i inplace -v module="$MODULE_NAME" '
            BEGIN { added=0 }
            /_COMMON_GKI_MODULES_LIST = \[/ { in_list=1 }
            in_list && /\]/ {
              if (!added) {
                print "    \"" module "\","
                added=1
              }
              in_list=0
            }
            in_list && !added {
              if (module < $0) {
                print "    \"" module "\","
                added=1
              }
            }
            { print }
          ' common/modules.bzl
          
      - name: Prepare module list for legacy builds
        if: ${{ github.event.inputs.android_version <= 13 }}
        run: |
          cd android-kernel
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_${{ github.event.inputs.target_arch }}_modules
      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3
      - name: Fix missing kprobe symbols for Android 13
        if: ${{ github.event.inputs.android_version == 13 }}
        run: |
          cd android-kernel
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${{ github.event.inputs.target_arch }} || \
            echo "$symbol" >> common/android/abi_gki_${{ github.event.inputs.target_arch }}
          done
          sed -i '/EXPORT_SYMBOL(unregister_kprobe);/a EXPORT_SYMBOL(register_kprobe);' common/kernel/kprobes.c
          
      - name: Build kernel module
        run: |
          cd android-kernel
          if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j32
            OUTPUT_PATH="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
          else
            echo "Using Bazel build system for Android ${{ github.event.inputs.android_version }}"
            tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist
            OUTPUT_PATH="out/kernel_${{ github.event.inputs.target_arch }}"
          fi
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}
          path: |
            android-kernel/${{ env.OUTPUT_PATH }}
          
          # æå–å†…æ ¸ä¸»æ¬¡ç‰ˆæœ¬
          KERNEL_MAJOR_MINOR=$(echo "$KERNEL_VERSION" | cut -d. -f1-2)
          KERNEL_PATCH=$(echo "$KERNEL_VERSION" | cut -d. -f3-)
          
          echo "ðŸ“Š Version breakdown:"
          echo "  Full version: $KERNEL_VERSION"
          echo "  Major.Minor: $KERNEL_MAJOR_MINOR"
          echo "  Patch: ${KERNEL_PATCH:-N/A}"
          
          # éªŒè¯æ”¯æŒçš„ç‰ˆæœ¬
          case "$KERNEL_MAJOR_MINOR" in
            "4.14"|"4.19"|"5.4")
              echo "âœ… Supported kernel series: $KERNEL_MAJOR_MINOR"
              ;;
            *)
              echo "âš ï¸ Warning: Kernel series $KERNEL_MAJOR_MINOR may not be fully supported for Android 10"
              echo "âœ… Recommended: 4.14.x, 4.19.x, or 5.4.x"
              ;;
          esac

      - name: Prepare kerneldriver directory
        run: |
          mkdir -p kerneldriver
          
          # å¤åˆ¶æ‰€æœ‰æºæ–‡ä»¶
          if [ -d "./code" ]; then
            echo "ðŸ“‚ Copying files from ./code directory..."
            find ./code -name "*.c" -exec cp {} kerneldriver/ \;
            find ./code -name "*.h" -exec cp {} kerneldriver/ \;
            find ./code -name "Makefile" -exec cp {} kerneldriver/ \;
            find ./code -name "Kconfig" -exec cp {} kerneldriver/ \;
          else
            echo "ðŸ“‚ Looking for driver files in root directory..."
            cp *.c kerneldriver/ 2>/dev/null || true
            cp *.h kerneldriver/ 2>/dev/null || true
            cp Makefile kerneldriver/ 2>/dev/null || true
            cp Kconfig kerneldriver/ 2>/dev/null || true
          fi
          
          # åˆ›å»ºå¿…è¦çš„æ–‡ä»¶
          if [ ! -f kerneldriver/Makefile ]; then
            echo "ðŸ“ Creating Makefile for Android 10 kernel module..."
            DRIVER_NAME="${{ github.event.inputs.driver_name }}"
            MODULE_NAME="${DRIVER_NAME%.ko}"
            
            cat > kerneldriver/Makefile << EOF
# SPDX-License-Identifier: GPL-2.0
obj-m += $MODULE_NAME.o
$MODULE_NAME-y := $(ls kerneldriver/*.c 2>/dev/null | head -1 | xargs basename -s .c | tr -d '\n')

ccflags-y := -I\$(srctree)/drivers/kerneldriver -Wno-error

# For Android 10 kernel compatibility
ifeq (\$(CONFIG_MODVERSIONS),y)
  \$(MODULE_NAME).o: \$(src)/compat_ver.h
endif
EOF
          fi
          
          # åˆ›å»ºå…¼å®¹æ€§å¤´æ–‡ä»¶
          cat > kerneldriver/compat_ver.h << 'EOF'
#ifndef _COMPAT_VER_H
#define _COMPAT_VER_H

#include <linux/version.h>

/* Android 10 kernel 4.14.141+ compatibility macros */

#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 14, 0)
#error "Kernel version too old, need at least 4.14"
#endif

/* Ensure we're building for Android 10 */
#ifdef CONFIG_ANDROID
#define ANDROID_VERSION 10
#endif

#endif /* _COMPAT_VER_H */
EOF
          
          echo "ðŸ“ Driver source prepared in kerneldriver/:"
          ls -la kerneldriver/

      - name: Install build dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for Android 10 kernel build..."
          sudo apt-get update
          sudo apt-get install -y \
            git \
            curl \
            python3 \
            build-essential \
            flex \
            bison \
            libssl-dev \
            libelf-dev \
            bc \
            rsync \
            kmod \
            device-tree-compiler \
            lz4 \
            lzop \
            dwarves \
            python3-pip
            
          # å®‰è£… repo å·¥å…·
          sudo pip3 install git-repo || true
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo
          
          echo "ðŸ“Ÿ Tools version:"
          repo --version 2>/dev/null || echo "Repo tool installed"
          make --version | head -1

      - name: Set up Android 10 Kernel with specific version
        id: init_kernel
        run: |
          echo "ðŸ“¥ Setting up Android 10 Kernel ${{ github.event.inputs.kernel_version }}"
          
          mkdir -p android-kernel && cd android-kernel
          
          FULL_VERSION="${{ github.event.inputs.kernel_version }}"
          MAJOR_MINOR=$(echo "$FULL_VERSION" | cut -d. -f1-2)
          
          echo "ðŸ” Looking for kernel version: $FULL_VERSION (series: $MAJOR_MINOR)"
          
          # Android 10 ç‰¹å®šç‰ˆæœ¬çš„åˆ†æ”¯/æ ‡ç­¾æ˜ å°„
          declare -A VERSION_MAP=(
            # 4.14.141+ ç³»åˆ—
            ["4.14.141"]="android-4.14-stable"
            ["4.14.141-rt"]="android-4.14-stable-rt"
            ["4.14.186"]="android-4.14-stable"
            ["4.14.207"]="android-4.14-stable"
            ["4.14.248"]="android-4.14-stable"
            
            # 4.19.x ç³»åˆ—
            ["4.19.81"]="android-4.19-stable"
            ["4.19.113"]="android-4.19-stable"
            ["4.19.152"]="android-4.19-stable"
            ["4.19.190"]="android-4.19-stable"
            
            # 5.4.x ç³»åˆ—
            ["5.4.42"]="android-5.4-stable"
            ["5.4.61"]="android-5.4-stable"
            ["5.4.86"]="android-5.4-stable"
            ["5.4.105"]="android-5.4-stable"
          )
          
          # å°è¯•ç²¾ç¡®ç‰ˆæœ¬åŒ¹é…
          BRANCH="${VERSION_MAP[$FULL_VERSION]}"
          
          if [ -n "$BRANCH" ]; then
            echo "âœ… Found exact match: $BRANCH for version $FULL_VERSION"
          else
            echo "âš ï¸ No exact match for $FULL_VERSION, trying generic branch..."
            
            # æ ¹æ®ä¸»æ¬¡ç‰ˆæœ¬é€‰æ‹©é€šç”¨åˆ†æ”¯
            case "$MAJOR_MINOR" in
              "4.14")
                BRANCH="android-4.14-stable"
                ;;
              "4.19")
                BRANCH="android-4.19-stable"
                ;;
              "5.4")
                BRANCH="android-5.4-stable"
                ;;
              *)
                BRANCH="android-4.14-stable"  # é»˜è®¤å›žé€€
                ;;
            esac
            echo "ðŸ“Œ Using generic branch: $BRANCH for series $MAJOR_MINOR"
          fi
          
          # è®°å½•ä½¿ç”¨çš„åˆ†æ”¯
          echo "selected_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "kernel_series=$MAJOR_MINOR" >> $GITHUB_OUTPUT

      - name: Initialize kernel repository
        run: |
          cd android-kernel
          BRANCH="${{ steps.init_kernel.outputs.selected_branch }}"
          
          echo "ðŸ”„ Initializing with branch: $BRANCH"
          
          # å°è¯•å¤šä¸ªé•œåƒæº
          MIRRORS=(
            "https://android.googlesource.com/kernel/manifest"
            "https://mirrors.tuna.tsinghua.edu.cn/git/AOSP/kernel/manifest"
            "https://mirror.nju.edu.cn/git/AOSP/kernel/manifest"
          )
          
          INIT_SUCCESS=false
          for MIRROR in "${MIRRORS[@]}"; do
            echo "ðŸŒ Trying mirror: $(echo $MIRROR | cut -d'/' -f3)"
            
            rm -rf .repo 2>/dev/null || true
            
            if timeout 300 repo init -u "$MIRROR" -b "$BRANCH" --depth=1; then
              echo "âœ… Successfully initialized from $MIRROR"
              INIT_SUCCESS=true
              break
            else
              echo "âŒ Failed with mirror: $(echo $MIRROR | cut -d'/' -f3)"
              sleep 2
            fi
          done
          
          if [ "$INIT_SUCCESS" = false ]; then
            echo "âŒ All mirrors failed, trying with --partial-clone..."
            repo init -u https://android.googlesource.com/kernel/manifest \
              -b "$BRANCH" \
              --partial-clone \
              --partial-clone-exclude=^.*/test/.*$ \
              --depth=1 || {
              echo "âŒ Repo init failed completely"
              exit 1
            }
          fi
          
          echo "ðŸ“ Repo initialized successfully"

      - name: Sync kernel sources with retry
        run: |
          cd android-kernel
          echo "ðŸ”„ Syncing kernel sources (this may take a while)..."
          
          # è®¾ç½®é‡è¯•æœºåˆ¶
          MAX_RETRIES=5
          RETRY_DELAY=30
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "ðŸ“¥ Sync attempt $i/$MAX_RETRIES"
            
            # ä½¿ç”¨ä¼˜åŒ–çš„ sync å‚æ•°
            if repo sync \
              -j$(($(nproc) * 2)) \
              -c \
              --no-tags \
              --optimized-fetch \
              --force-sync \
              --prune \
              --verbose \
              2>&1 | tee sync_attempt_$i.log; then
              
              echo "âœ… Sync completed successfully on attempt $i"
              
              # æ£€æŸ¥æ˜¯å¦åŒæ­¥åˆ°äº†æ­£ç¡®çš„ç‰ˆæœ¬
              if [ -f "Makefile" ]; then
                KERNEL_VERSION_SYNCED=$(grep -m1 "^VERSION =" Makefile | awk '{print $3}')
                PATCHLEVEL_SYNCED=$(grep -m1 "^PATCHLEVEL =" Makefile | awk '{print $3}')
                echo "ðŸ“‹ Synced kernel version: $KERNEL_VERSION_SYNCED.$PATCHLEVEL_SYNCED"
              fi
              
              break
            else
              echo "âŒ Sync failed on attempt $i"
              
              if [ $i -lt $MAX_RETRIES ]; then
                echo "â³ Waiting $RETRY_DELAY seconds before retry..."
                sleep $RETRY_DELAY
                
                # æ¸…ç†å¯èƒ½çš„é”å®šæ–‡ä»¶
                find .repo -name "*.lock" -delete 2>/dev/null || true
                
                # å¢žåŠ é‡è¯•å»¶è¿Ÿ
                RETRY_DELAY=$((RETRY_DELAY * 2))
              else
                echo "âŒ Sync failed after $MAX_RETRIES attempts"
                
                # å°è¯•éƒ¨åˆ†æ¢å¤
                echo "ðŸ”„ Trying recovery sync with limited threads..."
                repo sync -j4 --fail-fast 2>&1 | tee sync_recovery.log || {
                  echo "âŒ Recovery also failed"
                  
                  # è¾“å‡ºé”™è¯¯ä¿¡æ¯
                  echo "=== Last 50 lines of sync logs ==="
                  tail -50 sync_attempt_*.log 2>/dev/null || true
                  tail -50 sync_recovery.log 2>/dev/null || true
                  
                  exit 1
                }
              fi
            fi
          done
          
          echo "ðŸ“Š Repository size after sync:"
          du -sh . || true

      - name: Apply specific kernel version patches (if needed)
        id: apply_patches
        run: |
          cd android-kernel
          FULL_VERSION="${{ github.event.inputs.kernel_version }}"
          MAJOR_MINOR="${{ steps.init_kernel.outputs.kernel_series }}"
          
          echo "ðŸ”§ Checking kernel version: need $FULL_VERSION"
          
          # æ£€æŸ¥å½“å‰å†…æ ¸ç‰ˆæœ¬
          if [ -f "Makefile" ]; then
            VERSION=$(grep -m1 "^VERSION =" Makefile | awk '{print $3}')
            PATCHLEVEL=$(grep -m1 "^PATCHLEVEL =" Makefile | awk '{print $3}')
            SUBLEVEL=$(grep -m1 "^SUBLEVEL =" Makefile | awk '{print $3}' || echo "0")
            
            CURRENT_VERSION="$VERSION.$PATCHLEVEL.$SUBLEVEL"
            echo "ðŸ“‹ Current kernel version: $CURRENT_VERSION"
            
            if [[ "$CURRENT_VERSION" == "$FULL_VERSION"* ]]; then
              echo "âœ… Kernel version matches (or is close enough)"
              echo "patch_needed=false" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ Kernel version mismatch: have $CURRENT_VERSION, want $FULL_VERSION"
              echo "patch_needed=true" >> $GITHUB_OUTPUT
              
              # å°è¯•åº”ç”¨ç‰ˆæœ¬è¡¥ä¸
              echo "ðŸ©¹ Attempting to patch kernel version..."
              
              # ä¿®æ”¹ Makefile ä¸­çš„ç‰ˆæœ¬å·
              if [[ "$FULL_VERSION" == 4.14.* ]]; then
                TARGET_VERSION=4
                TARGET_PATCHLEVEL=14
                TARGET_SUBLEVEL=$(echo "$FULL_VERSION" | cut -d. -f3)
                
                sed -i "s/^VERSION = .*/VERSION = $TARGET_VERSION/" Makefile
                sed -i "s/^PATCHLEVEL = .*/PATCHLEVEL = $TARGET_PATCHLEVEL/" Makefile
                sed -i "s/^SUBLEVEL = .*/SUBLEVEL = $TARGET_SUBLEVEL/" Makefile
                
                echo "ðŸ“ Patched Makefile to version $FULL_VERSION"
              fi
            fi
          else
            echo "âš ï¸ Makefile not found, cannot check version"
            echo "patch_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Copy driver to kernel source tree
        run: |
          cd android-kernel
          echo "ðŸ“‚ Integrating driver into kernel tree..."
          
          # æŸ¥æ‰¾æ­£ç¡®çš„ drivers ç›®å½•
          DRIVERS_DIR=""
          if [ -d "drivers" ]; then
            DRIVERS_DIR="drivers"
          elif [ -d "common/drivers" ]; then
            DRIVERS_DIR="common/drivers"
          elif [ -d "kernel/drivers" ]; then
            DRIVERS_DIR="kernel/drivers"
          else
            # åˆ›å»º drivers ç›®å½•
            mkdir -p drivers
            DRIVERS_DIR="drivers"
          fi
          
          echo "ðŸ“ Using drivers directory: $DRIVERS_DIR"
          
          # å¤åˆ¶é©±åŠ¨
          cp -r ../kerneldriver "$DRIVERS_DIR/"
          
          # æ›´æ–° drivers/Makefile
          DRIVER_MAKEFILE="$DRIVERS_DIR/Makefile"
          if [ ! -f "$DRIVER_MAKEFILE" ]; then
            echo "ðŸ“ Creating $DRIVER_MAKEFILE"
            echo "# Kernel drivers Makefile" > "$DRIVER_MAKEFILE"
          fi
          
          # æ·»åŠ é©±åŠ¨åˆ° Makefile
          if ! grep -q "kerneldriver" "$DRIVER_MAKEFILE"; then
            echo "obj-y += kerneldriver/" >> "$DRIVER_MAKEFILE"
            echo "âœ… Added kerneldriver to $DRIVER_MAKEFILE"
          fi
          
          echo "ðŸ“ Driver files installed:"
          ls -la "$DRIVERS_DIR/kerneldriver/"

      - name: Configure kernel for module building
        run: |
          cd android-kernel
          echo "âš™ï¸ Configuring kernel for Android 10 module building..."
          
          # ä¸º Android 10 è®¾ç½®é…ç½®
          export ARCH="${{ github.event.inputs.target_arch }}"
          
          # å°è¯•åŠ è½½é»˜è®¤é…ç½®
          if [ -f "arch/$ARCH/configs/defconfig" ]; then
            echo "ðŸ“‹ Using arch/$ARCH/configs/defconfig"
            make defconfig
          elif [ -f "arch/arm64/configs/defconfig" ] && [ "$ARCH" = "aarch64" ]; then
            echo "ðŸ“‹ Using arch/arm64/configs/defconfig (aarch64 fallback)"
            make ARCH=arm64 defconfig
          else
            echo "âš ï¸ No defconfig found, using allyesconfig for module building"
            make allyesconfig
          fi
          
          # ç¡®ä¿æ¨¡å—æ”¯æŒå·²å¯ç”¨
          echo "ðŸ”§ Enabling module support..."
          sed -i 's/# CONFIG_MODULES is not set/CONFIG_MODULES=y/' .config 2>/dev/null || true
          echo "CONFIG_MODULES=y" >> .config
          
          # å…³é—­æ¨¡å—ç­¾åéªŒè¯ï¼ˆç®€åŒ–æž„å»ºï¼‰
          echo "CONFIG_MODULE_SIG=n" >> .config
          echo "CONFIG_MODULE_SIG_ALL=n" >> .config
          
          # æ›´æ–°é…ç½®
          make oldconfig 2>/dev/null || true
          
          echo "ðŸ“‹ Kernel configuration prepared"

      - name: Build kernel module for Android 10
        id: build_module
        run: |
          cd android-kernel
          echo "ðŸ”¨ Building kernel module for Android 10..."
          
          ARCH="${{ github.event.inputs.target_arch }}"
          DRIVER_NAME="${{ github.event.inputs.driver_name }}"
          MODULE_NAME="${DRIVER_NAME%.ko}"
          
          echo "ðŸ“Š Build parameters:"
          echo "  Architecture: $ARCH"
          echo "  Module name: $MODULE_NAME"
          echo "  Full version: ${{ github.event.inputs.kernel_version }}"
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          export ARCH
          export CROSS_COMPILE=aarch64-linux-gnu-  # æ ¹æ®å®žé™…æƒ…å†µè°ƒæ•´
          
          # å‡†å¤‡æž„å»º
          echo "ðŸ› ï¸ Preparing build environment..."
          
          # æŸ¥æ‰¾ drivers ç›®å½•
          if [ -d "drivers/kerneldriver" ]; then
            DRIVER_DIR="drivers/kerneldriver"
          elif [ -d "common/drivers/kerneldriver" ]; then
            DRIVER_DIR="common/drivers/kerneldriver"
          else
            echo "âŒ Driver directory not found!"
            find . -type d -name "kerneldriver" | head -5
            exit 1
          fi
          
          echo "ðŸ“ Building from: $DRIVER_DIR"
          
          # è¿›å…¥é©±åŠ¨ç›®å½•æž„å»º
          cd "$DRIVER_DIR"
          
          # åˆ›å»ºä¸´æ—¶ Makefile
          cat > Makefile.tmp << EOF
# Temporary Makefile for building Android 10 kernel module
ifeq (\$(KERNELRELEASE),)
    KERNEL_DIR ?= \$(CURDIR)/../..
    PWD := \$(shell pwd)

default:
	\$(MAKE) -C \$(KERNEL_DIR) M=\$(PWD) ARCH=$ARCH modules

clean:
	\$(MAKE) -C \$(KERNEL_DIR) M=\$(PWD) ARCH=$ARCH clean

.PHONY: default clean
else
    obj-m := $MODULE_NAME.o
    $MODULE_NAME-y := $(ls *.c 2>/dev/null | head -1 | xargs basename -s .c | tr -d '\n')
    ccflags-y := -I\$(src)
endif
EOF
          
          # æž„å»ºæ¨¡å—
          echo "ðŸš€ Starting module build..."
          make -f Makefile.tmp KERNEL_DIR=../.. ARCH=$ARCH 2>&1 | tee build.log
          
          # æ£€æŸ¥æž„å»ºç»“æžœ
          if [ -f "$MODULE_NAME.ko" ]; then
            echo "âœ… Module built successfully: $MODULE_NAME.ko"
            
            # æ£€æŸ¥æ¨¡å—ä¿¡æ¯
            echo "ðŸ“¦ Module information:"
            modinfo "$MODULE_NAME.ko" 2>/dev/null || true
            
            # è®°å½•è¾“å‡ºè·¯å¾„
            echo "MODULE_PATH=$(pwd)/$MODULE_NAME.ko" >> $GITHUB_ENV
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ Module build failed!"
            
            # è¾“å‡ºæž„å»ºé”™è¯¯
            echo "=== Build errors ==="
            grep -i "error" build.log | head -20 || true
            
            echo "=== Last 50 lines of build log ==="
            tail -50 build.log
            
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: Upload built module
        if: env.BUILD_SUCCESS == 'true'
        uses: actions/upload-artifact@v4.6.2
        with:
          name: android10-kernel-${{ github.event.inputs.kernel_version }}-module
          path: |
            ${{ env.MODULE_PATH }}
            android-kernel/.config
          retention-days: 30

      - name: Upload build logs and source
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: android10-build-logs-${{ github.event.inputs.kernel_version }}
          path: |
            android-kernel/sync_attempt_*.log
            android-kernel/build.log
            kerneldriver/
          retention-days: 7

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile

      - name: Add module to GKI modules list
        if: ${{ github.event.inputs.android_version > 13 }}
        run: |
          cd android-kernel
          MODULE_NAME="drivers/kerneldriver/${{ github.event.inputs.driver_name }}"
          
          awk -i inplace -v module="$MODULE_NAME" '
            BEGIN { added=0 }
            /_COMMON_GKI_MODULES_LIST = \[/ { in_list=1 }
            in_list && /\]/ {
              if (!added) {
                print "    \"" module "\","
                added=1
              }
              in_list=0
            }
            in_list && !added {
              if (module < $0) {
                print "    \"" module "\","
                added=1
              }
            }
            { print }
          ' common/modules.bzl
          
      - name: Prepare module list for legacy builds
        if: ${{ github.event.inputs.android_version <= 13 }}
        run: |
          cd android-kernel
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_${{ github.event.inputs.target_arch }}_modules
      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3
      - name: Fix missing kprobe symbols for Android 13
        if: ${{ github.event.inputs.android_version == 13 }}
        run: |
          cd android-kernel
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${{ github.event.inputs.target_arch }} || \
            echo "$symbol" >> common/android/abi_gki_${{ github.event.inputs.target_arch }}
          done
          sed -i '/EXPORT_SYMBOL(unregister_kprobe);/a EXPORT_SYMBOL(register_kprobe);' common/kernel/kprobes.c
          
      - name: Build kernel module
        run: |
          cd android-kernel
          if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j32
            OUTPUT_PATH="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
          else
            echo "Using Bazel build system for Android ${{ github.event.inputs.android_version }}"
            tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist
            OUTPUT_PATH="out/kernel_${{ github.event.inputs.target_arch }}"
          fi
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}
          path: |
            android-kernel/${{ env.OUTPUT_PATH }}
